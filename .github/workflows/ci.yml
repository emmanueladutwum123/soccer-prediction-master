name: Soccer Prediction CI/CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  setup-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Create project structure
      run: |
        echo "ðŸ“ Creating project structure..."
        mkdir -p data/raw data/processed data/features
        mkdir -p models/training models/trained_models models/evaluation
        mkdir -p src/data_collection src/feature_engineering src/modeling src/prediction src/web_app
        mkdir -p tests docs notebooks
        mkdir -p web_app/static web_app/templates
        echo "âœ… Project structure created"
    
    - name: Create requirements.txt
      run: |
        echo "ðŸ“¦ Creating requirements.txt..."
        echo "# Core packages" > requirements.txt
        echo "pandas==2.0.3" >> requirements.txt
        echo "numpy==1.24.3" >> requirements.txt
        echo "scikit-learn==1.3.0" >> requirements.txt
        echo "scipy==1.11.1" >> requirements.txt
        echo "" >> requirements.txt
        echo "# ML/DL" >> requirements.txt
        echo "xgboost==1.7.6" >> requirements.txt
        echo "lightgbm==4.0.0" >> requirements.txt
        echo "" >> requirements.txt
        echo "# Data collection" >> requirements.txt
        echo "requests==2.31.0" >> requirements.txt
        echo "beautifulsoup4==4.12.2" >> requirements.txt
        echo "" >> requirements.txt
        echo "# Web app" >> requirements.txt
        echo "flask==3.0.0" >> requirements.txt
        echo "plotly==5.17.0" >> requirements.txt
        echo "" >> requirements.txt
        echo "# Utilities" >> requirements.txt
        echo "python-dotenv==1.0.0" >> requirements.txt
        echo "joblib==1.3.1" >> requirements.txt
        echo "âœ… requirements.txt created"
    
    - name: Create setup.py
      run: |
        echo "âš™ï¸ Creating setup.py..."
        echo '#!/usr/bin/env python3' > setup.py
        echo '"""' >> setup.py
        echo 'Setup script for Soccer Prediction Master' >> setup.py
        echo '"""' >> setup.py
        echo 'import os' >> setup.py
        echo 'from pathlib import Path' >> setup.py
        echo '' >> setup.py
        echo 'print("ðŸš€ Setting up Soccer Prediction Master...")' >> setup.py
        echo '' >> setup.py
        echo '# Create directory structure' >> setup.py
        echo 'folders = [' >> setup.py
        echo "    'data/raw', 'data/processed', 'data/features'," >> setup.py
        echo "    'models/training', 'models/trained_models', 'models/evaluation'," >> setup.py
        echo "    'src/data_collection', 'src/feature_engineering'," >> setup.py
        echo "    'src/modeling', 'src/prediction', 'src/web_app'," >> setup.py
        echo "    'tests', 'docs', 'notebooks'," >> setup.py
        echo "    'web_app/static', 'web_app/templates'" >> setup.py
        echo ']' >> setup.py
        echo '' >> setup.py
        echo 'for folder in folders:' >> setup.py
        echo '    Path(folder).mkdir(parents=True, exist_ok=True)' >> setup.py
        echo '    print(f"  ðŸ“ Created: {folder}")' >> setup.py
        echo '' >> setup.py
        echo 'print("\nâœ… Setup complete!")' >> setup.py
        echo 'print("\nNext: pip install -r requirements.txt")' >> setup.py
        echo "âœ… setup.py created"
    
    - name: Create data collection module
      run: |
        echo "ðŸ“ Creating data collection module..."
        
        # Create src/data_collection/main.py
        mkdir -p src/data_collection
        cat > src/data_collection/main.py << 'EOF'
"""
Data Collection Module
"""
import pandas as pd
import logging

logger = logging.getLogger(__name__)

class DataCollector:
    """Simple data collector for now"""
    
    def __init__(self, api_key: str = None):
        self.api_key = api_key
        logger.info("DataCollector initialized")
    
    def collect_matches(self, league: str, season: str) -> pd.DataFrame:
        """Collect demo match data"""
        logger.info(f"Collecting demo matches for {league} {season}")
        
        # Return demo data
        return pd.DataFrame({
            'match_id': ['demo1', 'demo2', 'demo3'],
            'home_team': ['Team A', 'Team C', 'Team E'],
            'away_team': ['Team B', 'Team D', 'Team F'],
            'date': ['2024-01-01', '2024-01-02', '2024-01-03'],
            'league': [league, league, league],
            'season': [season, season, season],
            'home_score': [2, 1, 3],
            'away_score': [1, 2, 1],
            'result': ['H', 'D', 'H']
        })
EOF
        
        # Create src/data_collection/__init__.py
        cat > src/data_collection/__init__.py << 'EOF'
"""
Data Collection Package
"""
from .main import DataCollector

__version__ = "1.0.0"
__all__ = ['DataCollector']
EOF
        
        echo "âœ… Data collection module created"
    
    - name: Create other Python files
      run: |
        echo "ðŸ“ Creating other Python files..."
        
        # Create src/__init__.py
        echo '"""Soccer Prediction Master - Main Package"""' > src/__init__.py
        echo '__version__ = "1.0.0"' >> src/__init__.py
        echo '__author__ = "Soccer Prediction Team"' >> src/__init__.py
        echo 'print(f"âš½ Soccer Prediction Master v{__version__}")' >> src/__init__.py
        
        # Create other __init__.py files
        for dir in src/feature_engineering src/modeling src/prediction src/web_app; do
          echo '"""Package initialization"""' > $dir/__init__.py
        done
        
        echo '"""Web application package"""' > web_app/__init__.py
        
        echo "âœ… Other Python files created"
    
    - name: Create main.py
      run: |
        echo "ðŸŽ¯ Creating main.py..."
        
        cat > main.py << 'EOF'
#!/usr/bin/env python3
"""
Main entry point for Soccer Prediction Master
"""

import argparse
import sys
import logging
from pathlib import Path

# Setup logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

def collect_data(args):
    """Collect data from various sources"""
    try:
        # Import locally
        sys.path.insert(0, str(Path(__file__).parent / "src"))
        from data_collection.main import DataCollector
        
        logger.info(f"Starting data collection for {args.league} {args.season}")
        
        collector = DataCollector()
        matches = collector.collect_matches(args.league, args.season)
        
        if matches.empty:
            logger.warning("No data collected")
        else:
            logger.info(f"Collected {len(matches)} matches")
            # Save data
            output_dir = Path("data/raw")
            output_dir.mkdir(parents=True, exist_ok=True)
            output_file = output_dir / f"{args.league}_{args.season.replace('-', '_')}.csv"
            matches.to_csv(output_file, index=False)
            logger.info(f"Data saved to {output_file}")
            
        return True
    except ImportError as e:
        logger.error(f"Import error: {e}")
        logger.error("Make sure src/data_collection/main.py exists with DataCollector class")
        return False
    except Exception as e:
        logger.error(f"Error collecting data: {e}")
        return False

def train_model(args):
    """Train prediction models"""
    logger.info(f"Starting model training for {args.model}...")
    print(f"\nTraining {args.model} model for {args.epochs} epochs")
    print("This would:")
    print("1. Load historical match data")
    print("2. Engineer features")
    print("3. Train machine learning model")
    print("4. Evaluate and save the model")
    return True

def predict_match(args):
    """Predict match outcomes"""
    logger.info(f"Predicting match: {args.home} vs {args.away}")
    print(f"\nâš½ Match Prediction: {args.home} vs {args.away}")
    print(f"ðŸ“… Date: {args.date or 'Not specified'}")
    print("\nPredicted outcome:")
    print("Home win: 45%")
    print("Draw: 30%")
    print("Away win: 25%")
    print("\nRecommendation: Consider draw or home win")
    return True

def show_status():
    """Show project status"""
    print("\n" + "="*50)
    print("âš½ SOCCER PREDICTION MASTER - STATUS")
    print("="*50)
    
    # Check project structure
    paths = [
        ("requirements.txt", "Dependencies file"),
        ("setup.py", "Setup script"),
        ("src/data_collection", "Data collection module"),
        ("data/raw", "Raw data directory"),
        ("models", "Models directory")
    ]
    
    for path, desc in paths:
        exists = Path(path).exists()
        status = "âœ…" if exists else "âŒ"
        print(f"{status} {desc}: {path}")
    
    print("\nAvailable commands:")
    print("  python main.py collect --league EPL --season 2023-2024")
    print("  python main.py train --model xgboost")
    print("  python main.py predict --home 'Team A' --away 'Team B'")
    print("  python main.py status")
    print("\n" + "="*50)

def main():
    parser = argparse.ArgumentParser(
        description="âš½ Soccer Prediction Master - Advanced Prediction System"
    )
    
    subparsers = parser.add_subparsers(dest="command", help="Available commands")
    
    # Collect data command
    collect_parser = subparsers.add_parser("collect", help="Collect match data")
    collect_parser.add_argument("--league", default="EPL", help="League code (e.g., EPL)")
    collect_parser.add_argument("--season", default="2023-2024", help="Season (e.g., 2023-2024)")
    
    # Train model command
    train_parser = subparsers.add_parser("train", help="Train prediction models")
    train_parser.add_argument("--model", default="xgboost", help="Model type to train")
    train_parser.add_argument("--epochs", type=int, default=100, help="Training epochs")
    
    # Predict command
    predict_parser = subparsers.add_parser("predict", help="Predict match outcome")
    predict_parser.add_argument("--home", required=True, help="Home team")
    predict_parser.add_argument("--away", required=True, help="Away team")
    predict_parser.add_argument("--date", help="Match date (YYYY-MM-DD)")
    
    # Status command
    subparsers.add_parser("status", help="Show project status")
    
    # Parse arguments
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        show_status()
        sys.exit(0)
    
    # Execute command
    try:
        if args.command == "collect":
            success = collect_data(args)
        elif args.command == "train":
            success = train_model(args)
        elif args.command == "predict":
            success = predict_match(args)
        elif args.command == "status":
            show_status()
            sys.exit(0)
        else:
            logger.error(f"Unknown command: {args.command}")
            sys.exit(1)
        
        if success:
            logger.info("âœ… Command completed successfully")
            sys.exit(0)
        else:
            logger.error("âŒ Command failed")
            sys.exit(1)
            
    except Exception as e:
        logger.error(f"Error executing command: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
EOF
        echo "âœ… main.py created"
    
    - name: Create config.yaml
      run: |
        echo "âš™ï¸ Creating config.yaml..."
        echo '# config.yaml' > config.yaml
        echo 'project:' >> config.yaml
        echo '  name: "soccer-prediction-master"' >> config.yaml
        echo '  version: "1.0.0"' >> config.yaml
        echo '' >> config.yaml
        echo 'data:' >> config.yaml
        echo '  leagues:' >> config.yaml
        echo '    - name: "Premier League"' >> config.yaml
        echo '      code: "EPL"' >> config.yaml
        echo '    - name: "La Liga"' >> config.yaml
        echo '      code: "LL"' >> config.yaml
        echo '    - name: "Serie A"' >> config.yaml
        echo '      code: "SA"' >> config.yaml
        echo '' >> config.yaml
        echo 'modeling:' >> config.yaml
        echo '  test_size: 0.2' >> config.yaml
        echo '  random_state: 42' >> config.yaml
        echo "âœ… config.yaml created"
    
    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… Dependencies installed"
    
    - name: Run tests
      run: |
        echo "ðŸ§ª Running tests..."
        echo "1. Testing status command..."
        python main.py status
        echo "âœ… Status command works"
        
        echo "2. Testing collect command..."
        python main.py collect --league EPL --season 2023-2024
        echo "âœ… Collect command works"
        
        echo "3. Testing predict command..."
        python main.py predict --home "Man United" --away "Liverpool"
        echo "âœ… Predict command works"
        
        echo "4. Testing train command..."
        python main.py train --model xgboost --epochs 10
        echo "âœ… Train command works"
        
        echo "ðŸŽ‰ All tests passed!"
    
    - name: Show success message
      run: |
        echo "========================================"
        echo "ðŸŽ‰ SOCCER PREDICTION MASTER SETUP COMPLETE!"
        echo "========================================"
        echo ""
        echo "âœ… Project structure created"
        echo "âœ… Dependencies installed"
        echo "âœ… All CLI commands working"
        echo "âœ… Ready for development!"
        echo ""
        echo "Next steps:"
        echo "1. Run: python main.py status"
        echo "2. Start building your prediction system"
        echo "3. Implement real data collection APIs"
        echo ""
        echo "========================================"
