name: Soccer Prediction CI/CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  setup-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Create project structure
      run: |
        echo "ðŸ“ Creating project structure..."
        mkdir -p data/raw data/processed data/features
        mkdir -p models/training models/trained_models models/evaluation
        mkdir -p src/data_collection src/feature_engineering src/modeling src/prediction src/web_app
        mkdir -p tests docs notebooks
        mkdir -p web_app/static web_app/templates
        echo "âœ… Project structure created"
    
    - name: Create __init__.py files
      run: |
        echo "ðŸ“„ Creating __init__.py files..."
        touch src/__init__.py
        touch src/data_collection/__init__.py
        touch src/feature_engineering/__init__.py
        touch src/modeling/__init__.py
        touch src/prediction/__init__.py
        touch src/web_app/__init__.py
        touch web_app/__init__.py
        echo "âœ… __init__.py files created"
    
    - name: Create requirements.txt
      run: |
        echo "ðŸ“¦ Creating requirements.txt..."
        cat > requirements.txt << 'EOF'
# Core packages
pandas==2.0.3
numpy==1.24.3
scikit-learn==1.3.0
scipy==1.11.1

# ML/DL
xgboost==1.7.6
lightgbm==4.0.0

# Data collection
requests==2.31.0
beautifulsoup4==4.12.2

# Web app
flask==3.0.0
plotly==5.17.0

# Utilities
python-dotenv==1.0.0
joblib==1.3.1
EOF
        echo "âœ… requirements.txt created"
    
    - name: Create setup.py
      run: |
        echo "âš™ï¸ Creating setup.py..."
        cat > setup.py << 'EOF'
#!/usr/bin/env python3
"""
Setup script for Soccer Prediction Master
"""
import os
from pathlib import Path

print("ðŸš€ Setting up Soccer Prediction Master...")

# Create directory structure
folders = [
    'data/raw', 'data/processed', 'data/features',
    'models/training', 'models/trained_models', 'models/evaluation',
    'src/data_collection', 'src/feature_engineering',
    'src/modeling', 'src/prediction', 'src/web_app',
    'tests', 'docs', 'notebooks',
    'web_app/static', 'web_app/templates'
]

for folder in folders:
    Path(folder).mkdir(parents=True, exist_ok=True)
    print(f"  ðŸ“ Created: {folder}")

print("\nâœ… Setup complete!")
print("\nNext: pip install -r requirements.txt")
EOF
        echo "âœ… setup.py created"
    
    - name: Create src/data_collection/main.py
      run: |
        echo "ðŸ“ Creating src/data_collection/main.py..."
        mkdir -p src/data_collection
        cat > src/data_collection/main.py << 'EOF'
"""
Data Collection Module
"""
import pandas as pd
import logging

logger = logging.getLogger(__name__)

class DataCollector:
    """Simple data collector for now"""
    
    def __init__(self, api_key: str = None):
        self.api_key = api_key
        logger.info("DataCollector initialized")
    
    def collect_matches(self, league: str, season: str) -> pd.DataFrame:
        """Collect demo match data"""
        logger.info(f"Collecting demo matches for {league} {season}")
        
        # Return demo data
        return pd.DataFrame({
            'match_id': ['demo1', 'demo2', 'demo3'],
            'home_team': ['Team A', 'Team C', 'Team E'],
            'away_team': ['Team B', 'Team D', 'Team F'],
            'date': ['2024-01-01', '2024-01-02', '2024-01-03'],
            'league': [league, league, league],
            'season': [season, season, season],
            'home_score': [2, 1, 3],
            'away_score': [1, 2, 1],
            'result': ['H', 'D', 'H']
        })
EOF
        echo "âœ… src/data_collection/main.py created"
    
    - name: Create src/data_collection/__init__.py
      run: |
        echo "ðŸ“ Creating src/data_collection/__init__.py..."
        cat > src/data_collection/__init__.py << 'EOF'
"""
Data Collection Package
"""
from .main import DataCollector

__version__ = "1.0.0"
__all__ = ['DataCollector']
EOF
        echo "âœ… src/data_collection/__init__.py created"
    
    - name: Create other __init__.py files
      run: |
        echo "ðŸ“ Creating other __init__.py files..."
        echo '"""Package initialization"""' > src/__init__.py
        echo '"""Package initialization"""' > src/feature_engineering/__init__.py
        echo '"""Package initialization"""' > src/modeling/__init__.py
        echo '"""Package initialization"""' > src/prediction/__init__.py
        echo '"""Package initialization"""' > src/web_app/__init__.py
        echo '"""Package initialization"""' > web_app/__init__.py
        echo "âœ… Other __init__.py files created"
    
    - name: Create main.py
      run: |
        echo "ðŸŽ¯ Creating main.py..."
        cat > main.py << 'EOF'
#!/usr/bin/env python3
"""
Main entry point for Soccer Prediction Master
"""

import argparse
import sys
import logging
from pathlib import Path

# Setup logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

def collect_data(args):
    """Collect data from various sources"""
    try:
        # Import locally
        sys.path.insert(0, str(Path(__file__).parent / "src"))
        from data_collection.main import DataCollector
        
        logger.info(f"Starting data collection for {args.league} {args.season}")
        
        collector = DataCollector()
        matches = collector.collect_matches(args.league, args.season)
        
        if matches.empty:
            logger.warning("No data collected")
        else:
            logger.info(f"Collected {len(matches)} matches")
            # Save data
            output_dir = Path("data/raw")
            output_dir.mkdir(parents=True, exist_ok=True)
            output_file = output_dir / f"{args.league}_{args.season.replace('-', '_')}.csv"
            matches.to_csv(output_file, index=False)
            logger.info(f"Data saved to {output_file}")
            
        return True
    except ImportError as e:
        logger.error(f"Import error: {e}")
        logger.error("Make sure src/data_collection/main.py exists with DataCollector class")
        return False
    except Exception as e:
        logger.error(f"Error collecting data: {e}")
        return False

def train_model(args):
    """Train prediction models"""
    logger.info(f"Starting model training for {args.model}...")
    print(f"\nTraining {args.model} model for {args.epochs} epochs")
    print("This would:")
    print("1. Load historical match data")
    print("2. Engineer features")
    print("3. Train machine learning model")
    print("4. Evaluate and save the model")
    return True

def predict_match(args):
    """Predict match outcomes"""
    logger.info(f"Predicting match: {args.home} vs {args.away}")
    print(f"\nâš½ Match Prediction: {args.home} vs {args.away}")
    print(f"ðŸ“… Date: {args.date or 'Not specified'}")
    print("\nPredicted outcome:")
    print("Home win: 45%")
    print("Draw: 30%")
    print("Away win: 25%")
    print("\nRecommendation: Consider draw or home win")
    return True

def show_status():
    """Show project status"""
    print("\n" + "="*50)
    print("âš½ SOCCER PREDICTION MASTER - STATUS")
    print("="*50)
    
    # Check project structure
    paths = [
        ("requirements.txt", "Dependencies file"),
        ("setup.py", "Setup script"),
        ("src/data_collection", "Data collection module"),
        ("data/raw", "Raw data directory"),
        ("models", "Models directory")
    ]
    
    for path, desc in paths:
        exists = Path(path).exists()
        status = "âœ…" if exists else "âŒ"
        print(f"{status} {desc}: {path}")
    
    print("\nAvailable commands:")
    print("  python main.py collect --league EPL --season 2023-2024")
    print("  python main.py train --model xgboost")
    print("  python main.py predict --home 'Team A' --away 'Team B'")
    print("  python main.py status")
    print("\n" + "="*50)

def main():
    parser = argparse.ArgumentParser(
        description="âš½ Soccer Prediction Master - Advanced Prediction System"
    )
    
    subparsers = parser.add_subparsers(dest="command", help="Available commands")
    
    # Collect data command
    collect_parser = subparsers.add_parser("collect", help="Collect match data")
    collect_parser.add_argument("--league", default="EPL", help="League code (e.g., EPL)")
    collect_parser.add_argument("--season", default="2023-2024", help="Season (e.g., 2023-2024)")
    
    # Train model command
    train_parser = subparsers.add_parser("train", help="Train prediction models")
    train_parser.add_argument("--model", default="xgboost", help="Model type to train")
    train_parser.add_argument("--epochs", type=int, default=100, help="Training epochs")
    
    # Predict command
    predict_parser = subparsers.add_parser("predict", help="Predict match outcome")
    predict_parser.add_argument("--home", required=True, help="Home team")
    predict_parser.add_argument("--away", required=True, help="Away team")
    predict_parser.add_argument("--date", help="Match date (YYYY-MM-DD)")
    
    # Status command
    subparsers.add_parser("status", help="Show project status")
    
    # Parse arguments
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        show_status()
        sys.exit(0)
    
    # Execute command
    try:
        if args.command == "collect":
            success = collect_data(args)
        elif args.command == "train":
            success = train_model(args)
        elif args.command == "predict":
            success = predict_match(args)
        elif args.command == "status":
            show_status()
            sys.exit(0)
        else:
            logger.error(f"Unknown command: {args.command}")
            sys.exit(1)
        
        if success:
            logger.info("âœ… Command completed successfully")
            sys.exit(0)
        else:
            logger.error("âŒ Command failed")
            sys.exit(1)
            
    except Exception as e:
        logger.error(f"Error executing command: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
EOF
        echo "âœ… main.py created"
    
    - name: Create config.yaml
      run: |
        echo "âš™ï¸ Creating config.yaml..."
        cat > config.yaml << 'EOF'
# config.yaml
project:
  name: "soccer-prediction-master"
  version: "1.0.0"

data:
  leagues:
    - name: "Premier League"
      code: "EPL"
    - name: "La Liga"
      code: "LL"
    - name: "Serie A"
      code: "SA"

modeling:
  test_size: 0.2
  random_state: 42
EOF
        echo "âœ… config.yaml created"
    
    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… Dependencies installed"
    
    - name: Verify installation
      run: |
        echo "ðŸ§ª Verifying installation..."
        python -c "import pandas as pd; import numpy as np; import sklearn; import flask; print('âœ… All packages imported successfully!'); print(f'Pandas version: {pd.__version__}'); print(f'NumPy version: {np.__version__}')"
    
    - name: Test main.py commands
      run: |
        echo "ðŸš€ Testing main.py commands..."
        python main.py status
        python main.py collect --league EPL --season 2023-2024
        python main.py predict --home "Manchester United" --away "Liverpool"
        python main.py train --model xgboost --epochs 10
        echo "âœ… All commands tested successfully"
    
    - name: Test data collection
      run: |
        echo "ðŸ“Š Testing data collection..."
        if [ -f "data/raw/EPL_2023_2024.csv" ]; then
          echo "âœ… Data file created"
          echo "Sample:"
          head -n 3 data/raw/EPL_2023_2024.csv
        else
          echo "âš ï¸ Data file not found (demo mode may not create files)"
        fi
    
    - name: Test Python imports
      run: |
        echo "ðŸ Testing Python imports..."
        python -c "
import sys
sys.path.insert(0, 'src')
from data_collection.main import DataCollector
collector = DataCollector()
matches = collector.collect_matches('EPL', '2023-2024')
print(f'âœ… DataCollector works. Collected {len(matches)} demo matches')
        "
    
    - name: Create workflow summary
      run: |
        echo "## ðŸ“Š Workflow Summary" > summary.md
        echo "" >> summary.md
        echo "### âœ… Soccer Prediction Master Setup Complete" >> summary.md
        echo "" >> summary.md
        echo "**ðŸŽ¯ Status:** Success" >> summary.md
        echo "" >> summary.md
        echo "**ðŸ“ Files Created:**" >> summary.md
        echo "- Complete project structure" >> summary.md
        echo "- requirements.txt with ML packages" >> summary.md
        echo "- setup.py automation script" >> summary.md
        echo "- main.py CLI with 4 commands" >> summary.md
        echo "- config.yaml configuration" >> summary.md
        echo "- Data collection module" >> summary.md
        echo "" >> summary.md
        echo "**âœ… Tests Passed:**" >> summary.md
        echo "- Package installation" >> summary.md
        echo "- All CLI commands" >> summary.md
        echo "- Python imports" >> summary.md
        echo "" >> summary.md
        echo "**ðŸš€ Available Commands:**" >> summary.md
        echo "- python main.py status" >> summary.md
        echo "- python main.py collect --league EPL --season 2023-2024" >> summary.md
        echo "- python main.py predict --home 'Team A' --away 'Team B'" >> summary.md
        echo "- python main.py train --model xgboost" >> summary.md
        echo "" >> summary.md
        echo "**Next Steps:**" >> summary.md
        echo "1. Implement real API data collection" >> summary.md
        echo "2. Add feature engineering" >> summary.md
        echo "3. Train ML models" >> summary.md
        echo "4. Build web dashboard" >> summary.md
        echo "" >> summary.md
        echo "**Time:** $(date)" >> summary.md
        
        # Display summary
        cat summary.md
        
        # Also add to GitHub step summary
        cat summary.md >> $GITHUB_STEP_SUMMARY
    
    - name: Success notification
      if: success()
      run: |
        echo "ðŸŽ‰ CI/CD Pipeline SUCCESS!"
        echo "Your Soccer Prediction Master project is ready!"
        echo ""
        echo "Run: python main.py status"
