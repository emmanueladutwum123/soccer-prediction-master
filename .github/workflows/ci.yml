name: Soccer Prediction CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allows manual trigger

jobs:
  setup-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Create project structure
      run: |
        echo "üìÅ Creating project structure..."
        
        # Create directories
        mkdir -p data/raw data/processed data/features
        mkdir -p models/training models/trained_models models/evaluation
        mkdir -p src/data_collection src/feature_engineering src/modeling src/prediction src/web_app
        mkdir -p tests docs notebooks
        mkdir -p web_app/static web_app/templates
        
        # Create __init__.py files
        touch src/__init__.py
        touch src/data_collection/__init__.py
        touch src/feature_engineering/__init__.py
        touch src/modeling/__init__.py
        touch src/prediction/__init__.py
        touch src/web_app/__init__.py
        
        echo "‚úÖ Project structure created"
    
    - name: Create essential files
      run: |
        echo "üìù Creating essential files..."
        
        # Create requirements.txt
        cat > requirements.txt << 'EOF'
        # Core packages
        pandas==2.0.3
        numpy==1.24.3
        scikit-learn==1.3.0
        scipy==1.11.1
        
        # ML/DL
        xgboost==1.7.6
        lightgbm==4.0.0
        catboost==1.2.2
        
        # Data collection
        requests==2.31.0
        beautifulsoup4==4.12.2
        
        # Web app
        flask==3.0.0
        plotly==5.17.0
        
        # Utilities
        python-dotenv==1.0.0
        joblib==1.3.1
        EOF
        
        # Create setup.py
        cat > setup.py << 'EOF'
        #!/usr/bin/env python3
        """
        Setup script for Soccer Prediction Master
        """
        import os
        from pathlib import Path
        
        print("üöÄ Setting up Soccer Prediction Master...")
        
        # Create directory structure
        folders = [
            'data/raw', 'data/processed', 'data/features',
            'models/training', 'models/trained_models', 'models/evaluation',
            'src/data_collection', 'src/feature_engineering', 
            'src/modeling', 'src/prediction', 'src/web_app',
            'tests', 'docs', 'notebooks',
            'web_app/static', 'web_app/templates'
        ]
        
        for folder in folders:
            Path(folder).mkdir(parents=True, exist_ok=True)
            print(f"  üìÅ Created: {folder}")
            
            # Create __init__.py for Python packages
            if folder.startswith('src/'):
                init_file = Path(folder) / '__init__.py'
                if not init_file.exists():
                    init_file.write_text('"""Package initialization"""\n')
        
        print("\n‚úÖ Setup complete!")
        print("\nNext: pip install -r requirements.txt")
        EOF
        
        # Create main.py
        cat > main.py << 'EOF'
        #!/usr/bin/env python3
        """
        Soccer Prediction Master - Main Entry Point
        """
        print("‚öΩ Soccer Prediction Master")
        print("============================")
        print("Project setup successful!")
        print("\nTo get started:")
        print("1. Install dependencies: pip install -r requirements.txt")
        print("2. Run: python setup.py (if not already done)")
        print("3. Start building your prediction system")
        EOF
        
        # Create README.md if not exists
        if [ ! -f "README.md" ]; then
          cat > README.md << 'EOF'
          # ‚öΩ Soccer Prediction Master
          
          Advanced machine learning system for soccer match predictions.
          
          ## Setup
          
          1. Clone repository
          2. Run: `python setup.py`
          3. Install: `pip install -r requirements.txt`
          4. Start building!
          
          ## Project Structure
          
          - `data/` - Match data
          - `src/` - Source code
          - `models/` - ML models
          - `web_app/` - Dashboard
          
          ## License
          MIT License
          EOF
        fi
        
        echo "‚úÖ Essential files created"
    
    - name: Install dependencies
      run: |
        echo "üì¶ Installing dependencies..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "‚úÖ Dependencies installed"
    
    - name: Verify installation
      run: |
        echo "üß™ Verifying installation..."
        python -c "
        import pandas as pd
        import numpy as np
        import sklearn
        import xgboost
        import flask
        print('‚úÖ All packages imported successfully!')
        print(f'Pandas version: {pd.__version__}')
        print(f'NumPy version: {np.__version__}')
        "
    
    - name: Run setup script
      run: |
        echo "üöÄ Running setup script..."
        python setup.py
        echo "‚úÖ Setup script completed"
    
    - name: Test project
      run: |
        echo "üß™ Testing project..."
        
        # Test Python imports
        python -c "
        try:
            # Test if src package can be imported
            import src
            print('‚úÖ src package imported')
            
            # Test if we can create directories
            from pathlib import Path
            Path('test_dir').mkdir(exist_ok=True)
            print('‚úÖ File operations work')
            
        except Exception as e:
            print(f'‚ùå Error: {e}')
            exit(1)
        "
        
        # Check structure
        echo "üìÅ Checking project structure..."
        [ -f "requirements.txt" ] && echo "‚úÖ requirements.txt exists"
        [ -f "setup.py" ] && echo "‚úÖ setup.py exists"
        [ -f "main.py" ] && echo "‚úÖ main.py exists"
        [ -d "src/data_collection" ] && echo "‚úÖ src/data_collection exists"
        [ -f "src/__init__.py" ] && echo "‚úÖ src/__init__.py exists"
        
        echo "‚úÖ All tests passed!"
    
    - name: Create workflow summary
      if: always()
      run: |
        echo "## üìä Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ‚úÖ What was done:" >> $GITHUB_STEP_SUMMARY
        echo "1. Created project structure" >> $GITHUB_STEP_SUMMARY
        echo "2. Installed dependencies" >> $GITHUB_STEP_SUMMARY
        echo "3. Verified installation" >> $GITHUB_STEP_SUMMARY
        echo "4. Tested project setup" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üöÄ Next steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. Start building data collection module" >> $GITHUB_STEP_SUMMARY
        echo "2. Implement feature engineering" >> $GITHUB_STEP_SUMMARY
        echo "3. Train ML models" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Time:** $(date)" >> $GITHUB_STEP_SUMMARY
    
    - name: Upload logs (Optional)
      if: always()
      uses: actions/upload-artifact@v4  # CHANGED FROM v3 to v4
      with:
        name: setup-logs
        path: |
          requirements.txt
          setup.py
          main.py
        retention-days: 5

  success-notification:
    needs: setup-and-test
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Success
        run: |
          echo "üéâ CI/CD Pipeline Completed Successfully!"
          echo "Your Soccer Prediction Master project is ready."
          echo ""
          echo "Next: Start building your prediction system!"
          echo "Check the 'setup-and-test' job for details."

  failure-notification:
    needs: setup-and-test
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Failure
        run: |
          echo "‚ùå CI/CD Pipeline Failed!"
          echo "Check the 'setup-and-test' job logs for errors."
          echo ""
          echo "Common issues:"
          echo "1. Network issues during pip install"
          echo "2. Python version compatibility"
          echo "3. Missing file permissions"
