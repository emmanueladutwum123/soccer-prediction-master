name: Soccer Prediction CI/CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  setup-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Create project structure
      run: |
        echo "ðŸ“ Creating project structure..."
        mkdir -p data/raw data/processed data/features
        mkdir -p models/training models/trained_models models/evaluation
        mkdir -p src/data_collection src/feature_engineering src/modeling src/prediction src/web_app
        mkdir -p tests docs notebooks
        mkdir -p web_app/static web_app/templates
        echo "âœ… Project structure created"
    
    - name: Create __init__.py files
      run: |
        echo "ðŸ“„ Creating __init__.py files..."
        touch src/__init__.py
        touch src/data_collection/__init__.py
        touch src/feature_engineering/__init__.py
        touch src/modeling/__init__.py
        touch src/prediction/__init__.py
        touch src/web_app/__init__.py
        touch web_app/__init__.py
        echo "âœ… __init__.py files created"
    
    - name: Create requirements.txt
      run: |
        echo "ðŸ“¦ Creating requirements.txt..."
        echo "# Core packages" > requirements.txt
        echo "pandas==2.0.3" >> requirements.txt
        echo "numpy==1.24.3" >> requirements.txt
        echo "scikit-learn==1.3.0" >> requirements.txt
        echo "scipy==1.11.1" >> requirements.txt
        echo "" >> requirements.txt
        echo "# ML/DL" >> requirements.txt
        echo "xgboost==1.7.6" >> requirements.txt
        echo "lightgbm==4.0.0" >> requirements.txt
        echo "" >> requirements.txt
        echo "# Data collection" >> requirements.txt
        echo "requests==2.31.0" >> requirements.txt
        echo "beautifulsoup4==4.12.2" >> requirements.txt
        echo "" >> requirements.txt
        echo "# Web app" >> requirements.txt
        echo "flask==3.0.0" >> requirements.txt
        echo "plotly==5.17.0" >> requirements.txt
        echo "" >> requirements.txt
        echo "# Utilities" >> requirements.txt
        echo "python-dotenv==1.0.0" >> requirements.txt
        echo "joblib==1.3.1" >> requirements.txt
        echo "âœ… requirements.txt created"
    
    - name: Create setup.py
      run: |
        echo "âš™ï¸ Creating setup.py..."
        echo '#!/usr/bin/env python3' > setup.py
        echo '"""' >> setup.py
        echo 'Setup script for Soccer Prediction Master' >> setup.py
        echo '"""' >> setup.py
        echo 'import os' >> setup.py
        echo 'from pathlib import Path' >> setup.py
        echo '' >> setup.py
        echo 'print("ðŸš€ Setting up Soccer Prediction Master...")' >> setup.py
        echo '' >> setup.py
        echo '# Create directory structure' >> setup.py
        echo 'folders = [' >> setup.py
        echo "    'data/raw', 'data/processed', 'data/features'," >> setup.py
        echo "    'models/training', 'models/trained_models', 'models/evaluation'," >> setup.py
        echo "    'src/data_collection', 'src/feature_engineering'," >> setup.py
        echo "    'src/modeling', 'src/prediction', 'src/web_app'," >> setup.py
        echo "    'tests', 'docs', 'notebooks'," >> setup.py
        echo "    'web_app/static', 'web_app/templates'" >> setup.py
        echo ']' >> setup.py
        echo '' >> setup.py
        echo 'for folder in folders:' >> setup.py
        echo '    Path(folder).mkdir(parents=True, exist_ok=True)' >> setup.py
        echo '    print(f"  ðŸ“ Created: {folder}")' >> setup.py
        echo '' >> setup.py
        echo 'print("\nâœ… Setup complete!")' >> setup.py
        echo 'print("\nNext: pip install -r requirements.txt")' >> setup.py
        echo "âœ… setup.py created"
    
    - name: Create data collection module
      run: |
        echo "ðŸ“ Creating data collection module..."
        
        # Create main.py for data collection
        cat > src/data_collection/main.py << 'EOF'
"""
Data Collection Module
"""
import pandas as pd
import logging

logger = logging.getLogger(__name__)

class DataCollector:
    """Simple data collector for now"""
    
    def __init__(self, api_key: str = None):
        self.api_key = api_key
        logger.info("DataCollector initialized")
    
    def collect_matches(self, league: str, season: str) -> pd.DataFrame:
        """Collect demo match data"""
        logger.info(f"Collecting demo matches for {league} {season}")
        
        # Return demo data
        return pd.DataFrame({
            'match_id': ['demo1', 'demo2', 'demo3'],
            'home_team': ['Team A', 'Team C', 'Team E'],
            'away_team': ['Team B', 'Team D', 'Team F'],
            'date': ['2024-01-01', '2024-01-02', '2024-01-03'],
            'league': [league, league, league],
            'season': [season, season, season],
            'home_score': [2, 1, 3],
            'away_score': [1, 2, 1],
            'result': ['H', 'D', 'H']
        })
EOF
        
        # Create __init__.py for data collection
        cat > src/data_collection/__init__.py << 'EOF'
"""
Data Collection Package
"""
from .main import DataCollector

__version__ = "1.0.0"
__all__ = ['DataCollector']
EOF
        
        echo "âœ… Data collection module created"
    
    - name: Create other Python modules
      run: |
        echo "ðŸ“ Creating other Python modules..."
        echo '"""Soccer Prediction Master - Main Package"""' > src/__init__.py
        echo '__version__ = "1.0.0"' >> src/__init__.py
        echo '__author__ = "Soccer Prediction Team"' >> src/__init__.py
        echo 'print(f"âš½ Soccer Prediction Master v{__version__}")' >> src/__init__.py
        
        # Create simple __init__.py files for other directories
        for dir in src/feature_engineering src/modeling src/prediction src/web_app web_app; do
          echo '"""Package initialization"""' > $dir/__init__.py
        done
        
        echo "âœ… Other Python modules created"
    
    - name: Create main.py
      run: |
        echo "ðŸŽ¯ Creating main.py..."
        
        # Create main.py using simple echo commands to avoid EOF issues
        echo '#!/usr/bin/env python3' > main.py
        echo '"""' >> main.py
        echo 'Main entry point for Soccer Prediction Master' >> main.py
        echo '"""' >> main.py
        echo '' >> main.py
        echo 'import argparse' >> main.py
        echo 'import sys' >> main.py
        echo 'import logging' >> main.py
        echo 'from pathlib import Path' >> main.py
        echo '' >> main.py
        echo '# Setup logging' >> main.py
        echo 'logging.basicConfig(' >> main.py
        echo '    level=logging.INFO,' >> main.py
        echo '    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s"' >> main.py
        echo ')' >> main.py
        echo 'logger = logging.getLogger(__name__)' >> main.py
        echo '' >> main.py
        echo 'def collect_data(args):' >> main.py
        echo '    """Collect data from various sources"""' >> main.py
        echo '    try:' >> main.py
        echo '        # Import locally' >> main.py
        echo '        sys.path.insert(0, str(Path(__file__).parent / "src"))' >> main.py
        echo '        from data_collection.main import DataCollector' >> main.py
        echo '' >> main.py
        echo '        logger.info(f"Starting data collection for {args.league} {args.season}")' >> main.py
        echo '' >> main.py
        echo '        collector = DataCollector()' >> main.py
        echo '        matches = collector.collect_matches(args.league, args.season)' >> main.py
        echo '' >> main.py
        echo '        if matches.empty:' >> main.py
        echo '            logger.warning("No data collected")' >> main.py
        echo '        else:' >> main.py
        echo '            logger.info(f"Collected {len(matches)} matches")' >> main.py
        echo '            # Save data' >> main.py
        echo '            output_dir = Path("data/raw")' >> main.py
        echo '            output_dir.mkdir(parents=True, exist_ok=True)' >> main.py
        echo '            output_file = output_dir / f"{args.league}_{args.season.replace(\"-\", \"_\")}.csv"' >> main.py
        echo '            matches.to_csv(output_file, index=False)' >> main.py
        echo '            logger.info(f"Data saved to {output_file}")' >> main.py
        echo '' >> main.py
        echo '        return True' >> main.py
        echo '    except ImportError as e:' >> main.py
        echo '        logger.error(f"Import error: {e}")' >> main.py
        echo '        logger.error("Make sure src/data_collection/main.py exists with DataCollector class")' >> main.py
        echo '        return False' >> main.py
        echo '    except Exception as e:' >> main.py
        echo '        logger.error(f"Error collecting data: {e}")' >> main.py
        echo '        return False' >> main.py
        echo '' >> main.py
        echo 'def train_model(args):' >> main.py
        echo '    """Train prediction models"""' >> main.py
        echo '    logger.info(f"Starting model training for {args.model}...")' >> main.py
        echo '    print(f"\nTraining {args.model} model for {args.epochs} epochs")' >> main.py
        echo '    print("This would:")' >> main.py
        echo '    print("1. Load historical match data")' >> main.py
        echo '    print("2. Engineer features")' >> main.py
        echo '    print("3. Train machine learning model")' >> main.py
        echo '    print("4. Evaluate and save the model")' >> main.py
        echo '    return True' >> main.py
        echo '' >> main.py
        echo 'def predict_match(args):' >> main.py
        echo '    """Predict match outcomes"""' >> main.py
        echo '    logger.info(f"Predicting match: {args.home} vs {args.away}")' >> main.py
        echo '    print(f"\nâš½ Match Prediction: {args.home} vs {args.away}")' >> main.py
        echo '    print(f"ðŸ“… Date: {args.date or \"Not specified\"}")' >> main.py
        echo '    print("\nPredicted outcome:")' >> main.py
        echo '    print("Home win: 45%")' >> main.py
        echo '    print("Draw: 30%")' >> main.py
        echo '    print("Away win: 25%")' >> main.py
        echo '    print("\nRecommendation: Consider draw or home win")' >> main.py
        echo '    return True' >> main.py
        echo '' >> main.py
        echo 'def show_status():' >> main.py
        echo '    """Show project status"""' >> main.py
        echo '    print("\n" + "="*50)' >> main.py
        echo '    print("âš½ SOCCER PREDICTION MASTER - STATUS")' >> main.py
        echo '    print("="*50)' >> main.py
        echo '' >> main.py
        echo '    # Check project structure' >> main.py
        echo '    paths = [' >> main.py
        echo '        ("requirements.txt", "Dependencies file"),' >> main.py
        echo '        ("setup.py", "Setup script"),' >> main.py
        echo '        ("src/data_collection", "Data collection module"),' >> main.py
        echo '        ("data/raw", "Raw data directory"),' >> main.py
        echo '        ("models", "Models directory")' >> main.py
        echo '    ]' >> main.py
        echo '' >> main.py
        echo '    for path, desc in paths:' >> main.py
        echo '        exists = Path(path).exists()' >> main.py
        echo '        status = "âœ…" if exists else "âŒ"' >> main.py
        echo '        print(f"{status} {desc}: {path}")' >> main.py
        echo '' >> main.py
        echo '    print("\nAvailable commands:")' >> main.py
        echo '    print("  python main.py collect --league EPL --season 2023-2024")' >> main.py
        echo '    print("  python main.py train --model xgboost")' >> main.py
        echo '    print("  python main.py predict --home \"Team A\" --away \"Team B\"")' >> main.py
        echo '    print("  python main.py status")' >> main.py
        echo '    print("\n" + "="*50)' >> main.py
        echo '' >> main.py
        echo 'def main():' >> main.py
        echo '    parser = argparse.ArgumentParser(' >> main.py
        echo '        description="âš½ Soccer Prediction Master - Advanced Prediction System"' >> main.py
        echo '    )' >> main.py
        echo '' >> main.py
        echo '    subparsers = parser.add_subparsers(dest="command", help="Available commands")' >> main.py
        echo '' >> main.py
        echo '    # Collect data command' >> main.py
        echo '    collect_parser = subparsers.add_parser("collect", help="Collect match data")' >> main.py
        echo '    collect_parser.add_argument("--league", default="EPL", help="League code (e.g., EPL)")' >> main.py
        echo '    collect_parser.add_argument("--season", default="2023-2024", help="Season (e.g., 2023-2024)")' >> main.py
        echo '' >> main.py
        echo '    # Train model command' >> main.py
        echo '    train_parser = subparsers.add_parser("train", help="Train prediction models")' >> main.py
        echo '    train_parser.add_argument("--model", default="xgboost", help="Model type to train")' >> main.py
        echo '    train_parser.add_argument("--epochs", type=int, default=100, help="Training epochs")' >> main.py
        echo '' >> main.py
        echo '    # Predict command' >> main.py
        echo '    predict_parser = subparsers.add_parser("predict", help="Predict match outcome")' >> main.py
        echo '    predict_parser.add_argument("--home", required=True, help="Home team")' >> main.py
        echo '    predict_parser.add_argument("--away", required=True, help="Away team")' >> main.py
        echo '    predict_parser.add_argument("--date", help="Match date (YYYY-MM-DD)")' >> main.py
        echo '' >> main.py
        echo '    # Status command' >> main.py
        echo '    subparsers.add_parser("status", help="Show project status")' >> main.py
        echo '' >> main.py
        echo '    # Parse arguments' >> main.py
        echo '    args = parser.parse_args()' >> main.py
        echo '' >> main.py
        echo '    if not args.command:' >> main.py
        echo '        parser.print_help()' >> main.py
        echo '        show_status()' >> main.py
        echo '        sys.exit(0)' >> main.py
        echo '' >> main.py
        echo '    # Execute command' >> main.py
        echo '    try:' >> main.py
        echo '        if args.command == "collect":' >> main.py
        echo '            success = collect_data(args)' >> main.py
        echo '        elif args.command == "train":' >> main.py
        echo '            success = train_model(args)' >> main.py
        echo '        elif args.command == "predict":' >> main.py
        echo '            success = predict_match(args)' >> main.py
        echo '        elif args.command == "status":' >> main.py
        echo '            show_status()' >> main.py
        echo '            sys.exit(0)' >> main.py
        echo '        else:' >> main.py
        echo '            logger.error(f"Unknown command: {args.command}")' >> main.py
        echo '            sys.exit(1)' >> main.py
        echo '' >> main.py
        echo '        if success:' >> main.py
        echo '            logger.info("âœ… Command completed successfully")' >> main.py
        echo '            sys.exit(0)' >> main.py
        echo '        else:' >> main.py
        echo '            logger.error("âŒ Command failed")' >> main.py
        echo '            sys.exit(1)' >> main.py
        echo '' >> main.py
        echo '    except Exception as e:' >> main.py
        echo '        logger.error(f"Error executing command: {e}")' >> main.py
        echo '        sys.exit(1)' >> main.py
        echo '' >> main.py
        echo 'if __name__ == "__main__":' >> main.py
        echo '    main()' >> main.py
        
        echo "âœ… main.py created"
    
    - name: Create config.yaml
      run: |
        echo "âš™ï¸ Creating config.yaml..."
        echo '# config.yaml' > config.yaml
        echo 'project:' >> config.yaml
        echo '  name: "soccer-prediction-master"' >> config.yaml
        echo '  version: "1.0.0"' >> config.yaml
        echo '' >> config.yaml
        echo 'data:' >> config.yaml
        echo '  leagues:' >> config.yaml
        echo '    - name: "Premier League"' >> config.yaml
        echo '      code: "EPL"' >> config.yaml
        echo '    - name: "La Liga"' >> config.yaml
        echo '      code: "LL"' >> config.yaml
        echo '    - name: "Serie A"' >> config.yaml
        echo '      code: "SA"' >> config.yaml
        echo '' >> config.yaml
        echo 'modeling:' >> config.yaml
        echo '  test_size: 0.2' >> config.yaml
        echo '  random_state: 42' >> config.yaml
        echo "âœ… config.yaml created"
    
    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… Dependencies installed"
    
    - name: Run tests
      run: |
        echo "ðŸ§ª Running tests..."
        python main.py status
        echo "âœ… Status command works"
        python main.py collect --league EPL --season 2023-2024
        echo "âœ… Collect command works"
        python main.py predict --home "Man United" --away "Liverpool"
        echo "âœ… Predict command works"
        python main.py train --model xgboost --epochs 10
        echo "âœ… Train command works"
        echo "âœ… All tests passed!"
    
    - name: Success
      run: |
        echo "ðŸŽ‰ðŸŽ‰ðŸŽ‰ SUCCESS! ðŸŽ‰ðŸŽ‰ðŸŽ‰"
        echo "Soccer Prediction Master is fully set up!"
        echo ""
        echo "Next steps:"
        echo "1. Run: python main.py status"
        echo "2. Start building your prediction system"
        echo "3. Implement real data collection APIs"
